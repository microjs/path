<html>
  <head>
    <title>Mocha</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="mocha.css" />
  </head>
  <body>
    <div id="mocha"></div>
    <script src="mocha.js"></script>
    <script>mocha.setup('bdd')</script>
    <script src="../path.js"></script>
    <script src="hash-change.js"></script>
    <script>
      if (window.mochaPhantomJS) mochaPhantomJS.run();
      else {
        (function () {
          window.mochaResults = null;
          window.sendResults = sendResults;
          var events = [];
          function shallow(item, used) {
            if (typeof item === 'object' && item) {
              for (var i = 0; i < used.length; i++) {
                if (used[i] === item) return '[Circular Reference]';
              }
              used = used.concat([item]);
              var res = {};
              for (var key in item) {
                if (typeof item[key] != 'function' && key.substring(0, 1) != '_')
                  res[key] = shallow(item[key], used);
              }
              return res;
            } else {
              return item;
            }
          }
          window.stream = function () {
            var e = events;
            events = [];
            return e;
          };
          function sendResults(runner){
            var failed = [];

            var emit = runner.emit;
            runner.emit = function () {
              var args = Array.prototype.slice.call(arguments, 0);
              emit.apply(this, arguments);
              var shallowArgs = [];
              for (var i = 0; i < args.length; i++) {
                shallowArgs.push(shallow(args[i], []));
              }
              events.push(shallowArgs)
            };

            runner.on('fail', function(test, err){
              failed.push({
                title: test.title,
                fullTitle: test.fullTitle(),
                error: {
                  message: err.message,
                  stack: err.stack
                }
              });
            });

            runner.on('end', function(){
              runner.stats.failed = failed;
              window.mochaResults = runner.stats;
            });
          }
        }());
        sendResults(mocha.run());
      }
    </script>
  </body>
</html>
