<html>
  <head>
    <title>Mocha</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="mocha.css" />
  </head>
  <body>
    <div id="mocha"></div>
    <script src="http://component.jit.su/ForbesLindesay/jssn/download/jssn-dev.js"></script>
    <script src="mocha.js"></script>
    <script>mocha.setup('bdd')</script>
    <script src="../path.js"></script>
    <script src="hash-change.js"></script>
    <script>
      if (window.mochaPhantomJS) mochaPhantomJS.run();
      else {
        (function () {
          window.mochaResults = null;
          window.sendResults = sendResults;
          var events = [];
          window.stream = function () {
            var e = jssn.stringify(events);
            events = [];
            return e;
          };
          function sendResults(runner){
            var failed = [];

            var emit = runner.emit;
            runner.emit = function () {
              emit.apply(this, arguments);
              events.push(arguments)
            };

            runner.on('fail', function(test, err){
              failed.push({
                title: test.title,
                fullTitle: test.fullTitle(),
                error: {
                  message: err.message,
                  stack: err.stack
                }
              });
            });

            runner.on('end', function(){
              runner.stats.failed = failed;
              window.mochaResults = runner.stats;
            });
          }
        }());
        sendResults(mocha.run());
      }
    </script>
  </body>
</html>
